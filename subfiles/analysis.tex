\documentclass[../document.tex]{subfiles}

\begin{document}
	\subsection{Обзор предметной области}
	\par <<Дром>> --- автомобильный портал, являющийся <<доской объявлений>> о продаже автомобилей. Все проекты компании так или иначе связаны с этим порталом. Они включают в себя как составные части самого портала (объявления о продаже автомобилей, каталог, отзывы, и т.п.), так и различные связанные с ним мобильные приложения-клиенты (Дром Авто, Дром ПДД, Дром Штрафы). Отдельно можно выделить внутренние проекты, с которыми пользователи портала непосредственно не взаимодействуют. Целью данной работы является разработка системы A/B тестирования --- как раз одного из таких проектов.
	\par В процессе работы над проектами у всех команд возникает необходимость оценки того, как вносимые изменения и нововведения влияют на ключевые показатели продукта. Сравнение значений показателей до и после затруднено тем, что в таком случае невозможно установить причинно-следственные связи. Поэтому в компании применяется процедура, схожая с тем, как проводятся клинические испытания в медицине --- A/B тестирование.
	\par Основная идея A/B тестирования проста: пользователи разделяются на 2 или более группы. Каждая группа получает доступ к отдельной версии изменений, при этом пользователи, как правило, не знают, что участвуют в эксперименте. По истечении некоторого времени метрики групп сравниваются, и с помощью статистических тестов принимается решение о том, какая из групп лучше/хуже, либо о том, что существенных различий нет.
	\par На <<Дроме>> A/B тесты на текущий момент проводят аналитики данных. Это отнимает их рабочее время, что увеличивает сроки выполнения других задач, в том числе и сроки проведения других A/B тестов. Так как аналитики обеспечивают данными все команды, то это увеличивает задержки в выкатке новых функций продуктов и в целом уменьшает эффективность других команд. Ситуация усугубляется тем, что объём задач неравномерно распределён во времени, и значимая их часть появляется в конце каждого квартала, что создаёт <<завал>> и, опять же, не даёт другим командам подвести итоги квартала и поставить цели на следующий.
	\par Более того, проведение A/B тестов вручную делает де-факто невозможным наблюдение за процессом и остановку теста по достижению значимого результата, что потенциально увеличивает время, необходимое для проведения теста. Также становится невозможным исключить человеческий фактор: чем больше тестов проводится, тем больше вероятность ошибок. Так как перепроверка аналитических задач затруднена, то эти ошибки могут никогда не быть обнаруженными.
	\par Также, с ростом компании возрастает и количество проводимых A/B тестов: с <ЧИСЛО> в 2019 году до <ЧИСЛО> в 2020 году. Это также даёт свой вклад в нагрузку аналитиков и усугубляет описанные выше проблемы.
	\par Возможные решения:
	\begin{enumerate}
		\item Сохранение статуса-кво: тесты считаются аналитиками вручную, что несёт за собой проблемы, описанные выше;
		\item Набрать в штат больше аналитиков, чтобы уменьшить объём задач на одного аналитика. Это решит проблему в краткосрочной перспективе, но в долгосрочной при дальнейшем росте компании проблема возникнет вновь;
		\item Автоматизировать A/B тестирование. В данном случае есть 2 направления:
		\begin{enumerate}
			\item внедрить существующий коммерческий продукт;
			\item разработать и внедрить собственную систему.
		\end{enumerate}
	\end{enumerate}
	\par Таким образом, автоматизация A/B тестирования представляется целесообразной.
	\par Предполагаемая система, ввиду большого разнообразия технологий на <<Дроме>> не зависит от инфраструктуры и поэтому может быть применена для проведения A/B тестов в любой компании с такой необходимостью. В то же время, система ограничена тем, что содержащиеся в ней метрики разрабатываются под нужды <<Дрома>>, и поэтому не могут быть перенесены на другие компании. Поэтому данные метрики придётся разрабатывать заново.
	\par Постановка задачи: разработать и внедрить на <<Дроме>> систему автоматизированного A/B тестирования.
	\subsection{Обзор существующих методов решения}
	\subsubsection{Теоретические обоснования работы}
	\par A/B тесты по своей сути представляют собой рандомизированный эксперимент, решение в котором принимается с помощью статистических критериев. В результате эксперимента происходит тестирование одной или нескольких статистических гипотез. Как правило, это тестирование со сложными альтернативными гипотезами и двусторонними тестами.
	В большинстве случаев задача A/B тестирования формулируется следующим образом:
	\begin{equation}
		\begin{aligned}
			&H_0: \{\theta = \theta_0\},\\
			&H_1: \{\theta \ne \theta_0\},\\
			&P(\text{Отвергнуть }H_0|H_0\text{ верна}) =\alpha,\\
			&P(\text{Принять }H_0|H_0\text{ не верна}) =\beta.
		\end{aligned}
	\end{equation}
	\par Где:
	\begin{itemize}
		\item $H_0$ --- нулевая гипотеза (о том, что изменений нет);
		\item $H_1$ --- альтернативная гипотеза (изменения есть);
		\item $\alpha$ --- вероятность ошибки первого рода (уровень значимости);
		\item $\beta$ --- вероятность ошибки второго рода (мощность);
		\item $\theta$ --- изменение целевой метрики;
		\item $\theta_0$ --- изменение целевой метрики в нулевой гипотезе\\ (как правило, $\theta_0 = 0$).
	\end{itemize}
	\par В рамках данной работы наибольший интерес представляют 2 подзадачи: последовательное тестирование --- возможность остановки теста по достижению значимости, а не по окончанию запланированного на него времени, и уменьшение дисперсии --- возможность уменьшить время проведения теста за счёт учёта внешних факторов.
	\subsubsection{Практические обоснования работы}
	\par Группа американских учёных, работавших на компанию Optimizely\cite{optimizely} --- одну из компаний, специализирующихся на A/B тестировании и предоставляющих свою платформу на коммерческой основе, выпустила несколько работ о применении методов последовательного тестирования для A/B тестирования \cite{johari_peeking, johari_always_valid}. Основным результатом их работы является mSPRT --- статистический тест сложной гипотезы. В общем виде он записывается как
	\begin{equation}
		\Lambda_{n}^{H,\theta_0}=\int_{\Theta}\prod\limits_{m=1}^{n}\frac{f_{\theta}(X_m)}{f_{\theta_0}(X_m)}h(\theta)\mathrm{d}\theta
	\end{equation}
	\par Где:
	\begin{itemize}
		\item $\theta$ --- целевой параметр, например, разница средних;
		\item $\theta_0$ --- значение целевого параметра при нулевой гипотезе;
		\item $f_{\theta}$ --- плотность распределения;
		\item $h$ --- плотность смешивающего распределения;
		\item $X_m$ --- элемент данных.
	\end{itemize}
	\par При этом p-value имеет форму
	\begin{equation}
		p_0=1;\;p_n=\min\{p_{n-1},1/\Lambda_{n}^{H,\theta_0}\}
	\end{equation}
	\par Данный тест позволяет обрабатывать поступающие значения последовательно, и получать p-value в онлайн-режиме. Авторы предлагают в качестве смешивающего распределения принимать нормальное распределение $\mathcal{N}(0,\tau)$, где $\tau$ --- ожидаемый размер эффекта, который может как задаваться вручную перед проведением теста, так и вычисляться по результатами проведения предыдущих тестов. Смешивающее распределение в данном случае играет роль априорного распределения размера эффекта, и его выбор влияет на время проведения теста.
	\par Также авторы выводят формулы, применяющие этот тест к задаче A/B тестирования в случае нормального распределения исходных значений и распределения Бернулли:
	\begin{equation}
		\Lambda_{n}^{H,\theta_0} = \sqrt{\frac{2\sigma^2}{2\sigma^2 +n\tau^2}} \exp\left\{\frac{n^2\tau^2 (\overline{Y}_n-\overline{X}_n-\theta_0)^2}{4\sigma^2(2\sigma^2+n\tau^2)}\right\}
	\end{equation}
	\par Где:
	\begin{itemize}
		\item $\sigma$ --- стандартное отклонение объединённой выборки;
		\item $n$ --- объём объединённой выборки;
		\item $\tau$ --- ожидаемый размер эффекта;
		\item $\overline{X}_n,\ \overline{Y}_n$ --- средние двух популяций A/B теста.
	\end{itemize}
	\par Объём объединённой выборки будем считать как гармоническое среднее объёмов выборок \cite{welch_robust}
	\begin{equation}
		n=\frac{2\cdot n_1\cdot n_2}{n_1+n_2}
	\end{equation}
	\par Где $n_1,\ n_2$ --- размеры исходных выборок.
	\par Стандартное отклонение объединённой выборки будем считать как \cite{neil_sampling}
	\begin{equation}
		\sigma = \sqrt{\frac{1}{n_1+n_2-1}\left[(n_1-1)\sigma_1^2+(n_2-1)\sigma_2^2 +\frac{n_1 n_2}{n_1+n_2}(\overline{X}_n - \overline{Y}_n)^2\right]}
	\end{equation}
	\par Где $\sigma_1,\ \sigma_2$ --- стандартные отклонения исходных выборок.
	\par Данный тест используется в коммерческой системе Optimizely \cite{optimizely}.
	\par Другая важная работа \cite{bootstrap_msprt} сотрудников Walmart расширяет область применения mSPRT, поскольку не требует явно задавать семейство распределений и использует бутстрап для оценки функции правдоподобия по данным.
	\par Bootstrap mSPRT представляет собой алгоритм, который поблочно обрабатывает поступающие данные, чтобы в приближенном к онлайн режиме обновлять p-value. Заключается алгоритм в следующем:
	\begin{enumerate}
		\item Из смешивающего распределения сэмплируется выборка~$\left\{\tilde{\theta}_i\right\}_{i=1}^{M}$;
		\item Для каждого блока $\textbf{x}_k$:
		\begin{enumerate}
			\item Считается оценка параметра $\hat{\theta}_k$ и её стандартное отклонение $\sigma(\hat{\theta}_k)$;
			\item Из $\textbf{x}_k$ $B$ раз выбирается с возвратом выборка $\left\{\textbf{x}_k^{*b}\right\}_{b=1}^{B}$.\\Считается cтатистика
			\begin{equation}
				s_k^{*b}=\frac{\hat{\theta}_k^{*b} - \hat{\theta}_k}{\sigma(\hat{\theta}_k^{*b})}
			\end{equation}
			\item По последовательности $\left\{s_k^{*b}\right\}_{b=1}^{B}$ строится ядерная оценка плотности $g^{*}_k$.
		\end{enumerate}
		\item $L_n$ считается по формуле
		\begin{equation}
			L_n = \frac{1}{M}\left[
				\sum\limits_{m=1}^{M}\left(
					\frac{
						\prod_{k=1}^{n} g^{*}_k\left(\frac{\hat{\theta}_k - \tilde{\theta}_m}{\hat{\theta}_k}\right)
					}{
						\prod_{k=1}^{n} g^{*}_k\left(\frac{\hat{\theta}_k - \theta_0}{\hat{\theta}_k}\right)
					}
				\right)
			\right]
		\end{equation}
		\item p-value, аналогично обычному mSPRT, имеет вид
		\begin{equation}
			p_0=1;\;p_n=\min\{p_{n-1},1/L_n\}
		\end{equation}
	\end{enumerate}
	\par Данный критерий дорабатывается до применимости к A/B тестам аналогично mSPRT. Он применяется для A/B тестирования внутри Walmart.
	\par Стоит отметить, что данные критерии не требуют, хотя и разрешают, обработки поступающих данных в онлайн режиме или поблочно. Это свойство используется в данной работе для упрощения архитектуры разрабатываемой системы.
	\par Описанный выше подход не является единственным, так, байесовский подход \cite{stucchio_bayesian} применяется в другой крупной компании, занимающейся A/B тестами --- VWO \cite{vwo}. В данной работе было принято решение использовать именно частотные методы, так как, на момент написания работы, в байесовском A/B тестировании требовалось точно знать форму распределения исходных данных, что для большинства метрик было невозможно.
	\par Уменьшение дисперсии в A/B тестах также является актуальной темой. Такой метод уменьшения дисперсии, как контрольные ковариаты (control covariates) уже давно применяется в рандомизированных клинических исследованиях \cite{cuped}. Авторы из Microsoft предлагают в качестве такого ковариата использовать значение метрики в период до начала эксперимента. Метрика преобразуется следующим образом:
	\begin{equation}
		\tilde{Y}_{CUPED}=Y-\frac{\text{cov}(Y,Y_{pre})}{\text{var}(Y_{pre})}(Y_{pre}-\overline{Y}_{pre})
	\end{equation}
	\par В результате данного преобразования дисперсия $Y$ уменьшается пропорционально квадрату корреляции:
	\begin{equation}
		\text{var}(\tilde{Y}_{CUPED})=\text{var}(Y)\left(1-\text{cor}(Y,Y_{pre})^2\right)
	\end{equation}
	\par Где:
	\begin{itemize}
		\item $Y$ --- метрика внутри эксперимента;
		\item $Y_{pre}$ --- метрика до эксперимента;
		\item $\tilde{Y}_{CUPED}$ --- метрика с уменьшенной дисперсией.
	\end{itemize}
	\par Важным результатом является то, что:
	\begin{equation}
		\text{E}(Y)=\text{E}(\tilde{Y}_{CUPED})
	\end{equation}
	\par Статья \cite{boosting_ab} сотрудников Yandex развивает этот метод, используя современный алгоритм машинного обучения --- градиентный бустинг. Де-факто в работе предлагается заменить простую линейную модель из \cite{cuped} на более сложную нелинейную, для того, чтобы получить большую корреляцию, и, следовательно, большее уменьшение дисперсии.
	\par Основным результатом этой работы является то, что, преобразуя исходную метрику как:
	\begin{equation}
		\overset{\triangle}{Y}=Y-\tilde{Y}
	\end{equation}
	\par Эффект теста (среднее разницы между значениями метрик в двух когортах) сохраняет своё значение:
	\begin{equation}
		\text{ATE}(\overset{\triangle}{Y})=\text{ATE}(Y)
	\end{equation}
	\par И при этом дисперсия сокращается как:
	\begin{equation}
		\text{var}(\overset{\triangle}{Y})=\text{var}(Y)-\text{var}(\tilde{Y})
	\end{equation}
	\par Для вышеперечисленного необходимо, чтобы предиктор минимизировал RMSE, класс моделей должен быть закрытым по отношению к добавлению константы и умножению на скаляр. Утверждается, что градиентный бустинг на деревьях решений удовлетворяет данным критериям.
	\par Стоит отметить, что в данном случае результат достаточно чувствителен к переобучению модели.
	\subsubsection{Описание предшествующих работ}
	\par На <<Дроме>> на момент написания работы уже существовало 2 системы, связанных с A/B тестированием: панель администрирования A/B тестов и <<воронки>>.
	\par Панель администрирования A/B тестов позволяет создавать и управлять A/B тестами на вебе. При этом никакого функционала по подведению результатов тестов в ней не предусмотрено, и она позволяет только менять распределение пользователей по когортам (по последнему символу ID пользователя, от 0 до f) и включать/выключать тест. Более того, часто эта панель используется ещё и для постепенной раскатки новых функций на часть пользователей, без подсчёта каких-либо результатов. По результатам данной работы панель продолжает существовать независимо от разрабатываемой системы, так как фокус данной работы --- на подведении результатов тестов.
	\par <<Воронки>> являются сервисом, позволяющим проводить расчёты пользовательских воронок --- того, как пользователь проходит различные шаги на сайте. В воронки также был встроен механизм подсчёта простых A/B тестов: в случае конверсии, и только при фиксированном делении на группы, так как сервис не позволяет введения новых значений. Также не применяется никаких поправок на множественное сравнение, что неверно с статистической точки зрения. Доработке <<воронок>> мешает утеря знаний о их внутреннем устройстве и низкое качество кода. На текущее время воронки из-за своей негибкости практически не используются.
	\par Также стоит отметить, что оба этих сервиса умеют работать только с веб-частью <<Дрома>>. При этом разделение на когорты пользователей мобильных приложений происходит через Google Firebase.
	\subsection{Выводы}
	\par Таким образом, задачами данной работы являются разработка и внедрение системы автоматизированного A/B тестирования. Система должна использовать статистические методы, позволяющие решить задачу <<подглядывания>>, уменьшить время проведения теста за счёт учёта внешних, не зависящих от теста факторов, и, в итоге, увеличить количество проводимых A/B тестов в компании, параллельно увеличивая эффективность работы аналитиков данных и \\продакт-менеджеров.
	\par Разрабатываемая система должна отвечать следующим требованиям:
	\begin{enumerate}
		\item возможность проводить A/B тесты как в мобильных приложениях, так и на сайте;
		\item возможность самостоятельной поддержки (доработки) системы;
		\item возможность анализа сырых данных;
		\item поддержка метрик, отличных от конверсии;
		\item хостинг системы на своих серверах;
		\item использование корректных статистических методов;
		\item использование методик уменьшения дисперсии.
	\end{enumerate}
\end{document}